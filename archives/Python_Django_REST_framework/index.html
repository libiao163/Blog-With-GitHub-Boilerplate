<!DOCTYPE HTML>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Maverick,Galileo,blog" />
    <meta name="generator" content="Maverick 1.0" />
    <meta name="template" content="Galileo" />
    <link rel="alternate" type="application/rss+xml" title="悄悄生长 &raquo; RSS 2.0" href="/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="悄悄生长 &raquo; ATOM 1.0" href="/feed/atom/index.xml" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/assets/galileo-ec40839efa.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/assets/ExSearch/ExSearch-182e5a8868.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/b9ddedb092325d6048ba64cc6c5ea364.json"
        }
    </script>
    
<title>DRF 序列化反序列化 - 悄悄生长</title>
<meta name="author" content="酒后的阿bill" />
<meta name="description" content="Django REST framework 序列化反序列化" />
<meta property="og:title" content="DRF 序列化反序列化 - 悄悄生长" />
<meta property="og:description" content="Django REST framework 序列化反序列化" />
<meta property="og:site_name" content="悄悄生长" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/archives/Python_Django_REST_framework/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2019-12-27T16:23:00-00.00" />
<meta name="twitter:title" content="DRF 序列化反序列化 - 悄悄生长" />
<meta name="twitter:description" content="Django REST framework 序列化反序列化" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />

    </head>
    
    <body>
        
        <div class="container">
            <header id="ga-header">
                <div first>
                    <aside id="ga-logo">
                        <a href="/" target="_self">
                            <img src="https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/logo.png" alt="悄悄生长">
                        </a>
                    </aside>
                    <aside id="ga-brand">
                        <h1 class="brand"><a class="no-style" href="/">悄悄生长</a></h1>
                        <p>认真是我们参与这个社会的方式，认真是我们改变这个社会的方式</p>
                    </aside>
                </div>
                <div second id="ga-nav">
                    <nav class="navs">
                        <ul><li><a class="ga-highlight" href="/" target="_self">首页</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/archives/" target="_self">归档</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/about/" target="_self">关于</a></li><span class="separator">·</span><li><a href="#" target="_self" class="search-form-input ga-highlight">搜索</a></li></ul>
                    </nav>
                    <nav class="social-links">
                        <ul><li><a class="no-style" title="Twitter" href="https://twitter.com/" target="_blank"><i class="gi gi-twitter"></i>Twitter</a></li><span class="separator">·</span><li><a class="no-style" title="GitHub" href="https://github.com/libiao163" target="_blank"><i class="gi gi-github"></i>GitHub</a></li><span class="separator">·</span><li><a class="no-style" title="Weibo" href="https://weibo.com/6462830524/" target="_blank"><i class="gi gi-weibo"></i>Weibo</a></li></ul>
                    </nav>
                </div>
            </header>
            <div class="wrapper">
                
<main>    
    <section class="ga-section ga-content">
        <article class="yue">
            <h1 class="ga-post_title">DRF 序列化反序列化</h1>
            <span class="ga-post_meta ga-mono">
                <span>酒后的阿bill</span>
                <time>
                    2019-12-27
                </time>
                
                in <a no-style class="category" href="/category/devops/">
                    devops
                </a>
                
                
            </span>
            <div class="ga-content_body">
                <h1>1. 处理流程</h1>
<h2>1.1 反序列化(数据入库)：</h2>
<p>在creat e方法中把关联数据单独拿出来，先正常处理其中一个模型的数据(如果是多对一关系，则需要先创建“一”这个模型的数据)， 再调用自定义的函数处理另一个模型的数据。</p>
<h2>1.2 序列化(数据展示)：</h2>
<p>在to_representation方法中先正常取出其中一个模型的数据，再将另一个模型的数据增加到已经查询出的数据中。</p>
<h2>1.3 场景</h2>
<p>需要将服务器相关的数据存入到数据库中并在前端展示。服务器包括实例ID、CPU、内存等唯一且必需的参数，也包括数据磁盘这一特 殊参数：</p>
<ul>
<li><p>每台服务器的数据磁盘数量不固定，可能是0个(没有数据磁盘)，也可能是多个，但大部分服务器都是一个数据磁盘。</p>
</li>
<li><p>每一个数据磁盘都有磁盘ID、磁盘大小等参数。</p>
</li>
</ul>
<p>原始数据：</p>
<ul>
<li><p>三块数据磁盘</p>
<div class="highlight"><pre><span></span><span class="err">(&#39;instanceld&#39;:</span> <span class="err">&#39;ins-olfzusjv&#39;,</span> <span class="err">&#39;instanceType&#39;:</span> <span class="err">&#39;M</span><span class="mi">2</span><span class="err">.MEDIUM</span><span class="mi">16</span><span class="err">&#39;,</span> <span class="err">&#39;cpu&#39;:</span> <span class="mi">2</span><span class="err">,</span> <span class="err">&#39;memory&#39;:</span> <span class="mi">16</span><span class="err">,</span> <span class="err">&#39;instanceName&#39;:&#39;运维测试</span> <span class="mi">1</span><span class="err">-公用&#39;cre</span> <span class="err">atedTime&#39;:</span> <span class="err">&#39;</span><span class="mi">2019-11-14</span><span class="err">T</span><span class="mi">04</span><span class="err">:</span><span class="mi">57</span><span class="err">:</span><span class="mi">06</span><span class="err">Z&#39;,</span> <span class="err">&#39;expiredTime&#39;:</span> <span class="err">&#39;</span><span class="mi">2020-05-14</span><span class="err">T</span><span class="mi">04</span><span class="err">:</span><span class="mi">57</span><span class="err">:</span><span class="mi">11</span><span class="err">Z&#39;,</span> <span class="err">&#39;bandwidthOut&#39;:</span> <span class="mi">1</span><span class="err">,</span> <span class="err">&#39;systemDiskID&#39;:</span> <span class="err">&#39;disk</span><span class="mi">-3</span><span class="err">u</span><span class="mi">84</span><span class="err">a</span><span class="mi">3</span><span class="err">q</span> <span class="mi">5</span><span class="err">&#39;,</span> <span class="err">&#39;systemDiskSize&#39;:</span> <span class="mi">50</span><span class="err">,</span> <span class="err">&#39;dataDisks&#39;:</span> <span class="p">[</span><span class="err">(&#39;DiskSize&#39;:</span> <span class="mi">200</span><span class="p">,</span> <span class="err">&#39;DiskType&#39;:</span> <span class="err">&#39;CLOUD_SSD&#39;</span><span class="p">,</span> <span class="err">&#39;DiskId&#39;:</span> <span class="err">&#39;disk</span><span class="mi">-0</span><span class="err">sw</span><span class="mi">362</span><span class="err">zd&#39;</span><span class="p">,</span> <span class="err">&#39;DeleteWithI</span> <span class="err">nstance&#39;:</span> <span class="err">None)</span><span class="p">,</span> <span class="err">(&#39;DiskSize&#39;:</span> <span class="mi">110</span><span class="p">,</span> <span class="err">&#39;DiskType&#39;:</span> <span class="err">&#39;CLOUD_BASIC&#39;</span><span class="p">,</span> <span class="err">&#39;DiskId&#39;:</span> <span class="err">&#39;disk-nt</span><span class="mi">2</span><span class="err">s</span><span class="mi">8</span><span class="err">z</span><span class="mi">11</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;DeleteWithInstance&#39;:</span> <span class="err">None)</span><span class="p">,</span> <span class="err">(&#39;Di</span> <span class="err">skSize&#39;:</span> <span class="mi">100</span><span class="p">,</span> <span class="err">&#39;DiskType&#39;:</span> <span class="err">&#39;CLOUD_BASIC&#39;</span><span class="p">,</span> <span class="err">&#39;DiskId&#39;:</span> <span class="err">&#39;disk-h</span><span class="mi">00</span><span class="err">ds</span><span class="mi">6</span><span class="err">mt&#39;</span><span class="p">,</span> <span class="err">&#39;DeleteWithInstance&#39;:</span> <span class="err">None)</span><span class="p">]</span><span class="err">)</span>
</pre></div>
</li>
<li><p>无数据盘</p>
<div class="highlight"><pre><span></span><span class="err">(&#39;instanceld&#39;:</span> <span class="err">&#39;ins-olfzusjv&#39;,</span> <span class="err">&#39;instanceType&#39;:</span> <span class="err">&#39;M</span><span class="mi">2</span><span class="err">.MEDIUM</span><span class="mi">16</span><span class="err">&#39;,</span> <span class="err">&#39;cpu&#39;:</span> <span class="mi">2</span><span class="err">,</span> <span class="err">&#39;memory&#39;:</span> <span class="mi">16</span><span class="err">,</span> <span class="err">&#39;instanceName&#39;:&#39;运维测试</span> <span class="mi">1</span><span class="err">-公用&#39;cre</span> <span class="err">atedTime&#39;:</span> <span class="err">&#39;</span><span class="mi">2019-11-14</span><span class="err">T</span><span class="mi">04</span><span class="err">:</span><span class="mi">57</span><span class="err">:</span><span class="mi">06</span><span class="err">Z&#39;,</span> <span class="err">&#39;expiredTime&#39;:</span> <span class="err">&#39;</span><span class="mi">2020-05-14</span><span class="err">T</span><span class="mi">04</span><span class="err">:</span><span class="mi">57</span><span class="err">:</span><span class="mi">11</span><span class="err">Z&#39;,</span> <span class="err">&#39;bandwidthOut&#39;:</span> <span class="mi">1</span><span class="err">,</span> <span class="err">&#39;systemDiskID&#39;:</span> <span class="err">&#39;disk</span><span class="mi">-3</span><span class="err">u</span><span class="mi">84</span><span class="err">a</span><span class="mi">3</span><span class="err">q</span> <span class="mi">5</span><span class="err">&#39;,</span> <span class="err">&#39;systemDiskSize&#39;:</span> <span class="mi">50</span><span class="err">,</span> <span class="err">&#39;dataDisks&#39;:</span> <span class="err">None)</span>
</pre></div>
</li>
<li><p>使用两个模型存储数据：s ervers模型用于存储服务器的常规、普通参数对应的数据，datadisk模型用于存储数据磁盘的数据。</p>
</li>
<li><p>数据磁盘的数据在传入前进行处理，确保数据磁盘不存在时，它的值是一个空列表，而不是Non e或null。</p>
</li>
<li><p>通过调用API接口的方式，使用post方法手动传入数据。</p>
</li>
</ul>
<h1>2. code</h1>
<h2>2.1 创建模型</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Servers</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">instanceld</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s1">&#39;服务器实例 ID&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;服务器实例 ID&#39;</span><span class="p">)</span>
    <span class="n">instanceType</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s1">&#39;服务器实例类型’，max_length=32, help_text=&#39;</span><span class="n">服务器实例类型</span><span class="err">’</span><span class="p">)</span>
    <span class="n">cpu</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s1">&#39;CPU 核数&#39;</span><span class="err">，</span><span class="n">max_length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;CPU&#39;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;CPU 核数&#39;</span><span class="p">)</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s1">&#39;内存大小(GB)&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;内存大小(GB)&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DataDisk</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Servers</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dataDiskID</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s1">&#39;系统磁盘容量’，max_length=32, help_text=&#39;</span><span class="n">系统磁盘容量</span><span class="err">’</span><span class="p">)</span>
    <span class="n">dataDiskSize</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s1">&#39;系统磁盘容量’，max_length=10, help_text=&#39;</span><span class="n">系统磁盘容量</span><span class="err">’</span><span class="p">)</span>
</pre></div>
<h2>2.2 创建序列化类</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Servers</span><span class="p">,</span> <span class="n">DataDisk</span>
<span class="c1">#必须注意序列化时定义的字段和传入字段的一致性(名称、数据类型都要一致)，如果不一致则无法获取相关数据</span>
<span class="k">class</span> <span class="nc">ServerSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
  <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ReadOnlyField</span><span class="p">()</span>
  <span class="n">instanceId</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">cpu</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">memory</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">dataDisks</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ListField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="c1">#to_internal_value是反序列化的第一步 #它将传入的diet的键值对转换成二元元组</span>
  <span class="c1">#如果需要对传入的原始数据进行增删改，则在这个函数中完成</span>
  <span class="k">def</span> <span class="nf">to_internal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ServerSerializer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_internal_value</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

  <span class="c1">#字段级别的验证是在模型级别的验证之前进行的</span>
  <span class="c1">#字段级别的验证返回一个instance</span>
  <span class="c1">#如果需要对特定字段进行验证，则需要实现字段验证函数</span>
  <span class="c1">#字段验证函数的名称以’validate.&#39;为前缀，后面跟上模型中定义的字段名。如:validate_dataDisks</span>
  <span class="c1">#字段级别的验证示例如下:</span>
  <span class="c1">#def validate_manufacturer(self, value):</span>
  <span class="c1">#  &#39;&#39;&#39;</span>
  <span class="c1">#  字段级别的验证。返回一个instance 验证制造商记录是否存在，如果不存在则创建并返回一个instance，如果存在则直接返回一个instance</span>
  <span class="c1">#  &#39;&#39;&#39;</span>
  <span class="c1">#  try:</span>
  <span class="c1">#   return Manufacturer.objects.get(vendor_name_exact=value)</span>
  <span class="c1"># except Manufacturer.DoesNotExist:</span>
  <span class="c1">#   return self.create_manufacturer(value)</span>

  <span class="c1">#validate方法是模型级别的验证</span>
  <span class="c1">#只有经过模型验证后的数据才会被传给create、update方法</span>
  <span class="c1">#模型级别的验证示例如下:</span>
  <span class="c1"># def validate(self, attrs):</span>
  <span class="c1">#   &#39;&#39;&#39;</span>
  <span class="c1">#   对象级别的验证。验证服务器型号。先拿到制造商的instance,然后查找该制造商对应的记录是否存在该型号</span>
  <span class="c1">#   &#39;&#39;&#39;</span>
  <span class="c1">#   manufacturer_obj = attrs[&quot;manufacturer&quot;] </span>
  <span class="c1">#   try:</span>
  <span class="c1">#     attrs[&quot;model_name&quot;] = manufacturer_obj.productmodel_set.get(model_name_exact=attrs[&quot;model_name&quot;]) </span>
  <span class="c1">#     except </span>
  <span class="c1">#     ProductModel.DoesNotExist:</span>
  <span class="c1">#     attrs[&quot;model_name&quot;] = self.create_product_model(manufacturer_obj, attrs[&quot;model_name&quot;])</span>
  <span class="c1">#   return attrs</span>
  <span class="c1">#新增数据和更新数据的操作大同小异，区别在于传入到函数的参数中是否包含instance </span>
  <span class="c1">#如果有instance，则是数据更新，否则就是新增数据</span>

  <span class="c1">#create方法接收验证后的数据，并将数据保存到数据库中</span>
  <span class="c1">#如果涉及到模型的关联关系，即数据要存入到多张表中，则按下面的思路操作:</span>
  <span class="c1">#将关联表的数据单独从validated_data中提取出来，并传入自定义的函数中，通过该自定义函数完成关联模型数据的写入</span>
  <span class="c1">#示例如下:</span>
  <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
    <span class="n">instanceId</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">[</span><span class="s2">&quot;instanceId&quot;</span><span class="p">]</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getlnstance</span><span class="p">(</span><span class="n">instanceId</span><span class="p">)</span>
    <span class="n">dataDisks</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;dataDisks&quot;</span><span class="p">)</span>
      <span class="c1"># print(dataDisks)</span>
      <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_data_disk</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">dataDisks</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">Servers</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_data_disk</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">dataDisks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>
  <span class="c1"># update方法接收instance和validated_data，将指定的字段数据更新写入到数据库中</span>

  <span class="c1">#如果涉及模型的关联关系，则需要调用自定义的函数来实现关联表的更新操作</span>
  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">instance</span>

  <span class="c1">#获取服务器实例</span>
  <span class="k">def</span> <span class="nf">getInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instanceId</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">Servers</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instanceId_exact</span><span class="o">=</span><span class="n">instanceId</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Servers</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;服务器错误:{)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

  <span class="c1">#对关联模型操作的自定义函数</span>
  <span class="c1">#该函数实现了对磁盘信息的增、删、改</span>
  <span class="k">def</span> <span class="nf">check_data_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">dataDisks</span><span class="p">):</span>
    <span class="n">data_disk_queryset</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">datadisk_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">current_data_disk</span> <span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">datadisk</span> <span class="ow">in</span> <span class="n">dataDisks</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">data_disk_obj</span> <span class="o">=</span> <span class="n">data_disk_queryset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataDiskID_exact</span><span class="o">=</span><span class="n">datadisk</span><span class="p">[</span><span class="s1">&#39;DiskId&#39;</span><span class="p">])</span>
      <span class="k">except</span> <span class="n">DataDisk</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">data_disk_obj</span> <span class="o">=</span> <span class="n">DataDisk</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">dataDiskID</span><span class="o">=</span><span class="n">datadisk</span><span class="p">[</span><span class="s1">&#39;DiskId&#39;</span><span class="p">],</span> <span class="n">dataDiskSize</span><span class="o">=</span><span class="n">datadisk</span><span class="p">[</span><span class="s1">&#39;DiskSize&#39;</span><span class="p">],</span><span class="n">server</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
          <span class="n">current_data_disk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_disk_obj</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cleanDisk</span><span class="p">(</span><span class="n">data_disk_queryset</span><span class="p">,</span> <span class="n">current_data_disk</span><span class="p">)</span>

  <span class="c1">#自定义函数，用于删除多余的磁盘记录</span>
  <span class="k">def</span> <span class="nf">cleanDisk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_disk_queryset</span><span class="p">,</span> <span class="n">current_data_disk</span><span class="p">):</span>
    <span class="n">not_exists_disk</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data_disk_queryset</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_data_disk</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">not_exists_disk</span><span class="p">:</span>
      <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

  <span class="c1"># to_representation函数是序列化的最后一步，如果需要对序列化的数据进行增删改，则在该函数中实现</span>
  <span class="c1">#由于涉及模型关联，所以需要对返回给前 端的数据进行处理</span>
  <span class="c1">#通过模型关系取出数据磁盘的相关数据，并增加到需要返回给前端的数据中</span>
  <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ServerSerializer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">disks</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">datadisk_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">disks_list</span> <span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">disks</span><span class="p">:</span>
      <span class="n">disks_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;dataDisks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disks_list</span>
    <span class="k">return</span> <span class="n">ret</span>
</pre></div>
<h2>2.3 创建视图</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">ServerSerializer</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Servers</span>
<span class="k">class</span> <span class="nc">ServerViewset</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Servers</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ServerSerializer</span>
</pre></div>
<h2>2.4 URL</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">server.views</span> <span class="kn">import</span> <span class="n">ServerViewset</span>
<span class="n">route</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;servers&#39;</span><span class="p">,</span><span class="n">ServerViewset</span><span class="p">,</span><span class="n">base_name</span><span class="o">=</span><span class="s1">&#39;servers&#39;</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
  <span class="p">]</span>
</pre></div>

            </div>
        </article>
        <div id="ga-tags">
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/tag/Django/">#Django</a>
    </span>
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/tag/Python/">#Python</a>
    </span>
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/tag/DRF/">#DRF</a>
    </span>
    
</div>
    </section>

    
<section id="ga-content_pager">

    <div class="next">
        <a class="ga-highlight" href="/archives/mysql_scripts/">mysql 脚本汇总</a>
        <p class="yue">mysql数据库相关脚本</p>
    </div>


    <div class="prev">
        <a class="ga-highlight" href="/archives/my-first-awesome-post/">ansible keywords</a>
        <p class="yue">ansible keywords</p>
    </div>

</section>


    

</main>

                <footer class="ga-mono" id="ga-footer">
                    <section>
                        <span id="ga-uptime"></span>
                        <span class="brand">悄悄生长</span>
                    </section>
                    <section>
                        <p class="copyright">
                            <span>Copyright © 2019 酒后的阿bill</span>
                            <span>Powered by <a no-style href="https://github.com/AlanDecode/Maverick" target="_blank">Maverick & Galileo</a></span>
                        </p>
                        <div class="copyright">
                            <span class="footer-addon">
                                
                            </span>
                            <nav class="social-links">
                                <ul><li><a class="no-style" title="Twitter" href="https://twitter.com/" target="_blank"><i class="gi gi-twitter"></i>Twitter</a></li><span class="separator">·</span><li><a class="no-style" title="GitHub" href="https://github.com/libiao163" target="_blank"><i class="gi gi-github"></i>GitHub</a></li><span class="separator">·</span><li><a class="no-style" title="Weibo" href="https://weibo.com/6462830524/" target="_blank"><i class="gi gi-weibo"></i>Weibo</a></li></ul>
                            </nav>
                        </div>
                    </section>
                    <script>
                        var site_build_date = "2019-12-25T18:27+08:00"
                    </script>
                    <script src="https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/assets/galileo-d8a0a06eff.js"></script>
                </footer>
            </div>
        </div>
    </div>
        
        
        <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="pswp__bg"></div>
        <div class="pswp__scroll-wrap">
            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>
            <div class="pswp__ui pswp__ui--hidden">
                <div class="pswp__top-bar">
                    <div class="pswp__counter"></div>
                    <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                    <button class="pswp__button pswp__button--share" title="Share"></button>
                    <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                    <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                          <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                          </div>
                        </div>
                    </div>
                </div>
                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div> 
                </div>
                <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
                </button>
                <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
                </button>
                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/assets/ExSearch/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/assets/ExSearch/ExSearch-493cb9cd89.js"></script>
    
    <!--katex-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/assets/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/assets/katex.min.js"></script>
    <script>
    mathOpts = {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    };
    </script>
    <script defer src="https://cdn.jsdelivr.net/gh/libiao163/libiao163.github.io@master/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    
    </body>
</html>